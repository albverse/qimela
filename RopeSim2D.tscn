[gd_scene load_steps=5 format=3 uid="uid://dqkilcg3ns8ad"]

[ext_resource type="Script" uid="uid://bwnq4w6n0xdee" path="res://scene/RopeSim2D.gd" id="1_feydf"]
[ext_resource type="Texture2D" uid="uid://ckp5byo6jo0ah" path="res://scene/chain.png" id="2_nnocl"]
[ext_resource type="Texture2D" uid="uid://dtvs34dkeo2c4" path="res://icon.svg" id="3_nnocl"]

[sub_resource type="GDScript" id="GDScript_pfj2p"]
script/source = "extends Node2D
class_name RopeSim2D

# --- 物理参数（建议先用这组）---
@export var segments: int = 40          # 段数越多越圆滑
@export var segment_len: float = 10.0   # 每段长度，越小越细腻
@export var gravity: float = 2200.0
@export var damping: float = 0.99       # 越接近1越“拖”
@export var constraint_iters: int = 18  # 越大越不拉伸（更硬）

# 甩动手感：用“初速度”更真实，这个用来微调鞭梢感
@export var whip_strength: float = 0.0

# 初速度强度（越大甩得越猛）
@export var throw_speed: float = 900.0

@onready var line: Line2D = $\"../Line\"  # 与 Rope 同级的 Line2D

var active := false
var p: Array[Vector2] = []
var p_prev: Array[Vector2] = []

var start_pin := Vector2.ZERO
var end_pin := Vector2.ZERO
var pin_end := true
var throw_dir := Vector2.RIGHT

func _ready() -> void:
	line.visible = true
	line.width = 20
	line.default_color = Color(1,0,0,1)
	line.z_index = 999
	line.global_position = Vector2.ZERO
	line.clear_points()
	line.add_point(Vector2(200, 200))
	line.add_point(Vector2(800, 200))
	print(\"Line2D forced visible\")
	running = true
	pin_end = true
	$End.global_position = $Start.global_position + Vector2(500, -120)
	$Rope.begin($Start.global_position, ($End.global_position - $Start.global_position))

func begin(start_pos: Vector2, dir: Vector2) -> void:
	active = true
	throw_dir = dir.normalized()
	start_pin = start_pos
	end_pin = start_pos
	pin_end = true

	p.clear()
	p_prev.clear()

	# 初始化：点列沿 throw_dir 方向稍微展开一点
	for i in range(segments + 1):
		var pos := start_pos + throw_dir * (i * segment_len * 0.12)
		p.append(pos)
		p_prev.append(pos)

	# 关键：给整条绳子一个“初速度”（让它像甩出去一样）
	# p_prev 往“反方向”偏一点，就等价于当前有速度
	var v := throw_dir * throw_speed
	var dt := 1.0 / 60.0
	for i in range(1, segments + 1):
		var t := float(i) / float(segments)  # 越靠末端越快，像鞭子
		p_prev[i] = p[i] - v * (0.2 + 0.8 * t) * dt

	line.visible = true

func set_pins(start_pos: Vector2, end_pos: Vector2, end_is_pinned: bool) -> void:
	start_pin = start_pos
	end_pin = end_pos
	pin_end = end_is_pinned

func stop() -> void:
	active = false
	line.visible = false

func _physics_process(dt: float) -> void:
	if not active:
		return

	# 1) Verlet 积分：惯性 + 重力（中间点）
	for i in range(1, segments):
		var cur := p[i]
		var prev := p_prev[i]
		var vel := (cur - prev) * damping
		p_prev[i] = cur
		p[i] = cur + vel + Vector2(0, gravity) * dt * dt

	# 2) 甩动微调（可设为0，主要靠 throw_speed）
	if whip_strength != 0.0:
		for i in range(1, min(6, segments)):
			p[i] += throw_dir * whip_strength * float(6 - i)

	# 3) 长度约束：让每段保持 segment_len
	for _k in range(constraint_iters):
		p[0] = start_pin
		if pin_end:
			p[segments] = end_pin

		for i in range(segments):
			var a := p[i]
			var b := p[i + 1]
			var delta := b - a
			var dist := delta.length()
			if dist <= 0.0001:
				continue

			var diff := (dist - segment_len) / dist
			var move := delta * 0.5 * diff

			if i != 0:
				p[i] += move
			# 末端固定时不动末端
			if (i + 1 != segments) or (not pin_end):
				p[i + 1] -= move

	# 4) 输出到 Line2D（全局坐标）
	line.global_position = Vector2.ZERO
	line.clear_points()
	for i in range(segments + 1):
		line.add_point(p[i])
"

[node name="RopeSimDemo" type="Node2D"]
script = ExtResource("1_feydf")

[node name="Start" type="Marker2D" parent="."]
position = Vector2(146, 149)

[node name="End" type="Marker2D" parent="."]
position = Vector2(901, 168)

[node name="Line" type="Line2D" parent="."]
z_index = 999
z_as_relative = false
position = Vector2(49, 33)
points = PackedVector2Array(127, 137, 186, 137, 277, 129)
width = 5.0
texture = ExtResource("2_nnocl")
texture_mode = 2

[node name="Rope" type="Node2D" parent="."]
script = SubResource("GDScript_pfj2p")

[node name="Icon" type="Sprite2D" parent="."]
position = Vector2(496, 371)
scale = Vector2(0.5468751, 0.546875)
texture = ExtResource("3_nnocl")
